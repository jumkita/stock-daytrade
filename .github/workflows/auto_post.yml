name: Auto Post Buy Signals to X

on:
  schedule:
    # 平日（月〜金）06:00 UTC = 日本時間 15:00（ザラ場・最新価格取得）
    - cron: "0 6 * * 1-5"
  workflow_dispatch:

env:
  X_API_KEY: ${{ secrets.X_API_KEY }}
  X_API_SECRET: ${{ secrets.X_API_SECRET }}
  X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
  X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}

jobs:
  post:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install tweepy

      - name: リポジトリのファイル確認（logic.py が同じ階層にあるか）
        run: |
          echo "=== カレントディレクトリ ==="
          pwd
          echo "=== ルート直下の .py ファイル ==="
          ls -la *.py 2>/dev/null || true
          echo "=== logic を含むファイル名（大文字小文字区別） ==="
          ls -la logic.py 2>/dev/null || echo "logic.py なし"
          find . -maxdepth 2 -name "*.py" -type f | sort

      - name: Python から logic を import できるか確認
        working-directory: ${{ github.workspace }}
        run: |
          WP="$GITHUB_WORKSPACE"
          echo "WORKSPACE=$WP"
          export PYTHONPATH="$WP"
          python -c "import sys; print('sys.path[0:3]:', sys.path[0:3]); import logic; print('import logic OK')"

      - name: Run auto_post.py
        working-directory: ${{ github.workspace }}
        env:
          DAILY_SIGNALS_JSON_PATH: ${{ github.workspace }}/daily_buy_signals.json
          BULK_CHUNK_SIZE: "50"
        run: |
          WP="$GITHUB_WORKSPACE"
          export PYTHONPATH="$WP"
          python "$WP/auto_post.py"

      - name: 結果をリポジトリにコミット・プッシュ（Streamlit で自動表示用）
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add daily_buy_signals.json
          git diff --staged --quiet && echo "変更なし" || (git commit -m "chore: Update daily buy signals [automated]" && git push)
