name: Auto Post Buy Signals to X

on:
  schedule:
    # 平日（月〜金）07:00 UTC = 日本時間 16:00（大引け後）
    - cron: "0 7 * * 1-5"
  workflow_dispatch:

env:
  X_API_KEY: ${{ secrets.X_API_KEY }}
  X_API_SECRET: ${{ secrets.X_API_SECRET }}
  X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
  X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install tweepy

      - name: リポジトリのファイル確認（logic.py が同じ階層にあるか）
        run: |
          echo "=== カレントディレクトリ ==="
          pwd
          echo "=== ルート直下の .py ファイル ==="
          ls -la *.py 2>/dev/null || true
          echo "=== logic を含むファイル名（大文字小文字区別） ==="
          ls -la logic.py 2>/dev/null || echo "logic.py なし"
          find . -maxdepth 2 -name "*.py" -type f | sort

      - name: Python から logic を import できるか確認
        working-directory: ${{ github.workspace }}
        run: |
          WP="$GITHUB_WORKSPACE"
          echo "WORKSPACE=$WP"
          export PYTHONPATH="$WP"
          python -c "import sys; print('sys.path[0:3]:', sys.path[0:3]); import logic; print('import logic OK')"

      - name: Run auto_post.py
        working-directory: ${{ github.workspace }}
        run: |
          WP="$GITHUB_WORKSPACE"
          export PYTHONPATH="$WP"
          python "$WP/auto_post.py"
